package utils

import (
	"fmt"
	"io"
	"net/http"
	"os"
	"os/exec"
	"path/filepath"

	"golang.org/x/sys/windows/registry"
)

func OpenKey() {
	openKeyUrl := "https://github.com/tuyenvm/OpenKey/releases/download/2.0.5/OpenKey64-Windows-2.0.5-RC.zip"
	openKeyZip := filepath.Join(os.Getenv("TEMP"), "OpenKey.zip")
	openKeyDestination := filepath.Join(os.Getenv("USERPROFILE"), "Documents", "OpenKey")

	exec.Command("taskkill", "/F", "/IM", "OpenKey64.exe").Run()

	os.RemoveAll(openKeyDestination)
	os.MkdirAll(openKeyDestination, 0755)

	resp, _ := http.Get(openKeyUrl)
	if resp != nil {
		defer resp.Body.Close()
		file, _ := os.Create(openKeyZip)
		if file != nil {
			defer file.Close()
			io.Copy(file, resp.Body)
			file.Close()
		}
	}

	cmd := exec.Command("powershell", "-Command", "Expand-Archive", "-Path", openKeyZip, "-DestinationPath", openKeyDestination, "-Force")
	cmd.Run()

	os.Remove(openKeyZip)

	openKeyKey, err := registry.OpenKey(registry.CURRENT_USER, `SOFTWARE\TuyenMai\OpenKey`, registry.SET_VALUE)
	if err != nil {
		openKeyKey, _, err = registry.CreateKey(registry.CURRENT_USER, `SOFTWARE\TuyenMai\OpenKey`, registry.SET_VALUE)
		if err == nil {
			defer openKeyKey.Close()
		}
		return
	}
	defer openKeyKey.Close()

	openKeyKey.SetStringValue("ExecutablePath", filepath.Join(openKeyDestination, "OpenKey64.exe"))
	openKeyKey.SetDWordValue("vSwitchKeyStatus", 0x800842fe)
	openKeyKey.SetDWordValue("vInputType", 0x00000000)
	openKeyKey.SetDWordValue("vAllowConsoleZWNJ", 0x00000001)
	openKeyKey.SetDWordValue("vUseModernIME", 0x00000001)
	openKeyKey.SetDWordValue("vUseUnicodeSequencing", 0x00000001)
	openKeyKey.SetDWordValue("vSmartSwitch", 0x00000001)
	openKeyKey.SetDWordValue("vIgnoreCase", 0x00000001)
	openKeyKey.SetDWordValue("vUseUserFriendly", 0x00000001)
	openKeyKey.SetDWordValue("vUseModern", 0x00000001)
	openKeyKey.SetDWordValue("vProcessElevated", 0x00000001)
	openKeyKey.SetDWordValue("vInputType", 0x00000001)
	openKeyKey.SetDWordValue("vCheckVietnamese", 0x00000000)
	openKeyKey.SetDWordValue("vDefaultType", 0x00000000)
	openKeyKey.SetDWordValue("vUseModernDialog", 0x00000001)

	openKeyKey.SetBinaryValue("smartSwitchKey", []byte{
		0x08, 0x00, 0x42, 0xfe, 0x00, 0x01, 0x0a, 0x43, 0x00, 0x01, 0x04, 0x56,
		0x00, 0x01, 0x09, 0x41, 0x00, 0x01, 0x04, 0x4f, 0x00, 0x01, 0x0c, 0x45,
		0x00, 0x01, 0x08, 0x44, 0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x0f, 0x49,
		0x00, 0x01, 0x04, 0x4f, 0x00, 0x01, 0x0a, 0x45, 0x00, 0x01, 0x08, 0x41,
		0x00, 0x01, 0x06, 0x41, 0x00, 0x01, 0x09, 0x4f, 0x00, 0x01, 0x0d, 0x41,
		0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x0a, 0x55, 0x00, 0x01, 0x04, 0x59,
		0x00, 0x01, 0x08, 0x45, 0x00, 0x01, 0x05, 0x55, 0x00, 0x01, 0x07, 0x49,
		0x00, 0x01, 0x0f, 0x4f, 0x00, 0x01, 0x08, 0x41, 0x00, 0x01, 0x04, 0x4f,
		0x00, 0x01, 0x08, 0x45, 0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x0a, 0x57,
		0x00, 0x01, 0x0e, 0x4f, 0x00, 0x01, 0x09, 0x41, 0x00, 0x01, 0x09, 0x41,
		0x00, 0x01, 0x05, 0x41, 0x00, 0x01, 0x0a, 0x57, 0x00, 0x01, 0x05, 0x45,
		0x00, 0x01, 0x05, 0x41, 0x00, 0x01, 0x06, 0x45, 0x00, 0x01, 0x09, 0x41,
		0x00, 0x01, 0x05, 0x41, 0x00, 0x01, 0x0c, 0x45, 0x00, 0x01, 0x05, 0x49,
		0x00, 0x01, 0x09, 0x41, 0x00, 0x01, 0x06, 0x4f, 0x00, 0x01, 0x0a, 0x4f,
		0x00, 0x01, 0x07, 0x41, 0x00, 0x01, 0x0a, 0x4f, 0x00, 0x01, 0x07, 0x41,
		0x00, 0x01, 0x09, 0x4f, 0x00, 0x01, 0x05, 0x41, 0x00, 0x01, 0x09, 0x55,
		0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x07, 0x41, 0x00, 0x01, 0x0d, 0x4f,
		0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x08, 0x4f, 0x00, 0x01, 0x08, 0x41,
		0x00, 0x01, 0x05, 0x55, 0x00, 0x01, 0x08, 0x4f, 0x00, 0x01, 0x08, 0x45,
		0x00, 0x01, 0x06, 0x41, 0x00, 0x01, 0x0a, 0x55, 0x00, 0x01, 0x0c, 0x4f,
		0x00, 0x01, 0x07, 0x41, 0x00, 0x01, 0x09, 0x55, 0x00, 0x01, 0x06, 0x49,
		0x00, 0x01, 0x07, 0x41, 0x00, 0x01, 0x0a, 0x4f, 0x00, 0x01, 0x08, 0x41,
		0x00, 0x01, 0x06, 0x4f, 0x00, 0x01, 0x09, 0x41, 0x00, 0x01, 0x08, 0x41,
		0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x0a, 0x55, 0x00, 0x01, 0x05, 0x49,
		0x00, 0x01, 0x08, 0x41, 0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x07, 0x49,
		0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x0a, 0x41,
		0x00, 0x01, 0x05, 0x41, 0x00, 0x01, 0x08, 0x41, 0x00, 0x01, 0x07, 0x49,
		0x00, 0x01, 0x08, 0x4f, 0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x08, 0x41,
		0x00, 0x01, 0x05, 0x41, 0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x07, 0x4f,
		0x00, 0x01, 0x07, 0x55, 0x00, 0x01, 0x07, 0x55, 0x00, 0x01, 0x07, 0x41,
		0x00, 0x01, 0x08, 0x4f, 0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x07, 0x49,
		0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x07, 0x55, 0x00, 0x01, 0x07, 0x4f,
		0x00, 0x01, 0x08, 0x41, 0x00, 0x01, 0x07, 0x41, 0x00, 0x01, 0x06, 0x55,
		0x00, 0x01, 0x06, 0x55, 0x00, 0x01, 0x0a, 0x57, 0x00, 0x01, 0x0e, 0x4f,
		0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x07, 0x4f, 0x00, 0x01, 0x08, 0x41,
		0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	})

	openKeyKey.SetBinaryValue("languageSet", []byte{
		0x09, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	})
}

func InstallOpenKey() error {
	openKeyPath := filepath.Join(os.Getenv("USERPROFILE"), "Documents", "OpenKey", "OpenKey64.exe")
	if _, err := os.Stat(openKeyPath); err == nil {
		fmt.Printf("[+] OpenKey đã cài đặt... bỏ qua\n")
		return nil
	}

	fmt.Printf("[*] Đang cài đặt OpenKey...\n")
	OpenKey()
	fmt.Printf("[+] Đã cài đặt OpenKey xong\n")
	return nil
}
